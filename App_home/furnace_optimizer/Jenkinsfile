pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'DZ_furnace-optimizer', 
                     url: 'https://github.com/VladislavLavrov/423901_devops_SuvorovOleg.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('App_home/furnace_optimizer') {
                    sh 'docker build -t furnace_app .'
                }
            }
        }

        stage('Run Container') {
            steps {
                dir('App_home/furnace_optimizer') {
                    sh '''
                        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                        docker stop furnace_app || true
                        docker rm furnace_app || true
                        
                        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π
                        docker run -d \
                            --name furnace_app \
                            --restart unless-stopped \
                            -p 8000:8000 \
                            furnace_app
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                sh '''
                    sleep 10
                    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
                    curl -f http://localhost:8000 && \
                    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!" || \
                    echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
            echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: http://93.88.178.186:8000"
            echo "üìã –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: docker ps"
        }
        failure {
            echo "‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π!"
        }
        // –£–ë–ò–†–ê–ï–ú docker compose down!
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–º
    }
}